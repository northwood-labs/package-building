---
# This workflow uses actions that are not certified by GitHub. They are provided
# by a third-party and are governed by separate terms of service, privacy
# policy, and support documentation.

################################################################################
# DO NOT EDIT THIS FILE!
# 
# 1. Edit the *.gotmpl.yml files instead.
# 2. go run generate-workflow.go -t _download-and-package.gotmpl.yml -p woke -r 'get-woke/woke' -c '10 17 * * *'
################################################################################

name: Build woke
on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - ".github/workflows/build-woke.yml"
      - "packages/woke/**"
  pull_request:
    branches: [main]
    paths:
      - ".github/workflows/build-woke.yml"
      - "packages/woke/**"
  schedule:
    - cron: '10 17 * * *'

defaults:
  run:
    shell: bash

env:
  DOCKER_BUILDKIT: 1
  REGISTRY: ${{ vars.REGISTRY }}

permissions: read-all

jobs:
  lookup:
    runs-on: ubuntu-latest
    name: Lookup current version
    permissions:
      packages: write
      contents: read
    strategy:
      fail-fast: false

    container:
      image: ghcr.io/northwood-labs/package-builder/ubuntu-v22.04:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    outputs:
      cache_hit: ${{ steps.check.outputs.cache-hit }}
      package_version: ${{ steps.lookup_version.outputs.package_version }}

    steps:
      - name: Lookup latest version of package
        id: lookup_version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "package_version=$(download-asset latest-tag -r 'get-woke/woke' -s)" >> $GITHUB_OUTPUT

      - name: Check to see if we've already built this version
        uses: actions/cache/restore@v4
        id: check
        with:
          key: "woke-${{ steps.lookup_version.outputs.package_version }}"
          path: "packages/woke/dist"
          lookup-only: true

  build:
    if: needs.lookup.outputs.cache_hit != 'true'
    needs: lookup
    name: Build and cache
    uses: northwood-labs/package-building/.github/workflows/build-and-cache.yml@main
    secrets: inherit
    with:
      package-name: "woke"
      package-version: ${{ needs.lookup.outputs.package_version }}

  upload:
    if: needs.lookup.outputs.cache_hit != 'true'
    needs: build
    name: Upload to S3
    uses: northwood-labs/package-building/.github/workflows/upload-to-s3.yml@main
    secrets: inherit
    with:
      package-name: "woke"
      package-version: ${{ needs.lookup.outputs.package_version }}

  metadata:
    if: needs.lookup.outputs.cache_hit != 'true'
    needs: upload
    name: Generate metadata
    uses: northwood-labs/package-building/.github/workflows/generate-rpm-meta.yml@main
    secrets: inherit
