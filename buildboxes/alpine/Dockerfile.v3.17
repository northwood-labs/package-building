# syntax=docker/dockerfile:1
FROM --platform=$TARGETPLATFORM golang:alpine3.17
SHELL ["/bin/ash", "-euxo", "pipefail", "-c"]

################################################################################
# DO NOT EDIT THIS FILE!
# 
# 1. Edit the *.gotmpl files instead.
# 2. Run 'go run generate-from-templates.go'.
################################################################################

# Informational
ARG TARGETPLATFORM
ARG BUILDPLATFORM
RUN echo "I am running on $BUILDPLATFORM, building for $TARGETPLATFORM."

# Identify ourselves
ENV OS_DIST alpine
ENV OS_DIST_VER 3.17
ENV OS_DIST_PKG apk

# Environment variables
ENV CGO_ENABLED 0
ENV PIP_ROOT_USER_ACTION ignore

# Temporary. Remove as soon as we can.
# RUN echo "busybox==1.36.1-r2" >>/etc/apk/world
# RUN echo "busybox-binsh==1.36.1-r2" >>/etc/apk/world

# Install Packages
RUN apk upgrade --update --no-cache
RUN apk add --no-cache \
    alpine-conf \
    alpine-sdk \
    bash \
    ca-certificates \
    cargo \
    cargo-auditable \
    coreutils \
    curl \
    docker \
    git \
    gnupg \
    gpg \
    gzip \
    jq \
    libc6-compat \
    libffi-dev \
    libgit2-dev \
    make \
    openssh-client \
    poetry \
    py3-pip \
    py3-virtualenv \
    python3 \
    python3-dev \
    tree \
    unzip \
    util-linux \
    wget \
    xz \
    zlib-dev \
    ;

COPY download-asset.toml /etc/download-asset/download-asset.toml
RUN go install github.com/northwood-labs/download-asset@latest

RUN --mount=type=secret,id=GITHUB_TOKEN GITHUB_TOKEN="$(cat /run/secrets/GITHUB_TOKEN)" \
    download-asset get --owner-repo goreleaser/goreleaser-pro

# Labels
ARG BUILD_DATE
ARG VCS_REF

# https://github.com/opencontainers/image-spec/blob/master/annotations.md
LABEL org.opencontainers.image.title="Package Builder: Alpine 3.17"
LABEL org.opencontainers.image.description="Container image to help facilitate building packages for Alpine."
LABEL org.opencontainers.image.url="https://github.com/northwood-labs/package-building"
LABEL org.opencontainers.image.documentation="https://github.com/northwood-labs/package-building/wiki"
LABEL org.opencontainers.image.vendor="Northwood Labs"
LABEL org.opencontainers.image.authors="Ryan Parman <rparman@northwood-labs.com>"
LABEL org.opencontainers.image.created="$BUILD_DATE"
LABEL org.opencontainers.image.source="git@github.com:northwood-labs/package-building.git"
LABEL org.opencontainers.image.revision="$VCS_REF"
LABEL org.opencontainers.image.licenses="Apache-2.0"
